<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recettes de la Semaine</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <button class="season-switch" onclick="switchSeason()">Changer Saison</button>
    <button class="refresh-button" onclick="window.location.reload()">Actualiser</button>
    <button class="print-button" onclick="printTable()">Imprimer</button>
    <div id="seasonIndicator">Saison actuelle : Toutes</div>

    <table id="lunchTable">
        <thead>
            <tr>
                <th>Lundi</th>
                <th>Mardi</th>
                <th>Mercredi</th>
                <th>Jeudi</th>
                <th>Vendredi</th>
                <th>Samedi</th>
                <th>Dimanche</th>
            </tr>
        </thead>
        <thead>
            <tr>
                <th colspan="7">Repas du Midi</th>
            </tr>
        </thead>
        <tbody id="lunchRecipesRow"></tbody>
    </table>

    <table id="dinnerTable">
        <thead>
            <tr>
                <th colspan="7">Repas du Soir</th>
            </tr>
        </thead>
        <tbody id="dinnerRecipesRow"></tbody>
    </table>

    <script>
        let lunchRecipesList = [];
        let dinnerRecipesList = [];
        let remainingLunchRecipes = [];
        let remainingDinnerRecipes = [];
        let currentSeason = ''; // Default to all recipes
        let allRecipes = [];

        function getRandomWeightedRecipe(recipes) {
            const weightedRecipes = recipes.map(recipe => {
                const weight = recipe.frequence === 'souvent' ? 2 : 1;
                return { recipe, weight };
            });

            const totalWeight = weightedRecipes.reduce((sum, recipe) => sum + recipe.weight, 0);
            let random = Math.random() * totalWeight;

            for (const { recipe, weight } of weightedRecipes) {
                if (random < weight) {
                    return recipe;
                }
                random -= weight;
            }
        }

        function getRandomRecipes(recipes, count) {
            const selectedRecipes = [];
            const availableRecipes = [...recipes];

            while (selectedRecipes.length < count && availableRecipes.length > 0) {
                const recipe = getRandomWeightedRecipe(availableRecipes);
                selectedRecipes.push(recipe);
                const index = availableRecipes.indexOf(recipe);
                availableRecipes.splice(index, 1);
            }

            return selectedRecipes;
        }

        function displayRecipes(recipes, tableId) {
            const recipesRow = document.getElementById(tableId);
            recipesRow.innerHTML = '';

            recipes.forEach((recipe, index) => {
                const recipeCell = document.createElement('td');
                recipeCell.innerHTML = `
                    <h3>${recipe.name}</h3>
                    <div class="image-container">
                        <img src="${recipe.imageURL}" alt="${recipe.name}">
                    </div>
                    <button class="remove-button" onclick="removeRecipe('${tableId}', ${index})">Supprimer</button>
                `;
                recipesRow.appendChild(recipeCell);
            });

            // Fill the remaining days with empty cells if less than 7 recipes
            const remainingDays = 7 - recipes.length;
            for (let i = 0; i < remainingDays; i++) {
                const emptyCell = document.createElement('td');
                emptyCell.innerHTML = `<h3>Pas de recette</h3>`;
                recipesRow.appendChild(emptyCell);
            }
        }

        function removeRecipe(tableId, index) {
            const isLunchTable = tableId === 'lunchRecipesRow';
            const remainingRecipes = isLunchTable ? remainingLunchRecipes : remainingDinnerRecipes;
            const recipesList = isLunchTable ? lunchRecipesList : dinnerRecipesList;

            if (remainingRecipes.length === 0) {
                alert('Plus de recettes disponibles pour remplacer.');
                return;
            }

            const newRecipe = getRandomWeightedRecipe(remainingRecipes);
            recipesList[index] = newRecipe;
            const newIndex = remainingRecipes.indexOf(newRecipe);
            remainingRecipes.splice(newIndex, 1);

            displayRecipes(recipesList, tableId);
        }

        function switchSeason() {
            if (currentSeason === '') {
                currentSeason = 'ete';
            } else if (currentSeason === 'ete') {
                currentSeason = 'hiver';
            } else {
                currentSeason = '';
            }

            let seasonText = 'Toutes';
            if (currentSeason === 'ete') {
                seasonText = 'Été';
            } else if (currentSeason === 'hiver') {
                seasonText = 'Hiver';
            }

            document.getElementById('seasonIndicator').innerText = `Saison actuelle : ${seasonText}`;
            loadSeasonRecipes();
        }

        function loadSeasonRecipes() {
            let seasonRecipes;
            if (currentSeason === '') {
                seasonRecipes = allRecipes;
            } else {
                seasonRecipes = allRecipes.filter(recipe => recipe.saison === currentSeason || recipe.saison === '');
            }

            remainingLunchRecipes = seasonRecipes.filter(recipe => recipe.repas === 'midi');
            remainingDinnerRecipes = seasonRecipes.filter(recipe => recipe.repas === 'soir');

            lunchRecipesList = getRandomRecipes(remainingLunchRecipes, 7);
            dinnerRecipesList = getRandomRecipes(remainingDinnerRecipes, 7);

            displayRecipes(lunchRecipesList, 'lunchRecipesRow');
            displayRecipes(dinnerRecipesList, 'dinnerRecipesRow');
        }

        function printTable() {
            const lunchTable = document.getElementById('lunchTable').outerHTML;
            const dinnerTable = document.getElementById('dinnerTable').outerHTML;
            const originalContents = document.body.innerHTML;

            document.body.innerHTML = lunchTable + dinnerTable;
            window.print();
            document.body.innerHTML = originalContents;

            // Re-attach the event handlers since the innerHTML change removes them
            attachEventHandlers();
        }

        function attachEventHandlers() {
            document.querySelector('.season-switch').onclick = switchSeason;
            document.querySelector('.refresh-button').onclick = () => window.location.reload();
            document.querySelector('.print-button').onclick = printTable;
        }

        fetch('assets/js/file.json')
            .then(response => response.json())
            .then(data => {
                allRecipes = data;
                loadSeasonRecipes();
                attachEventHandlers();
            })
            .catch(error => console.error('Erreur lors du chargement des recettes:', error));
    </script>
</body>
</html>
